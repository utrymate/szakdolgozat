<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="utf-8" />
</head>
<style>
    .addEdge {
        text-align: center;
    }

    th, td {
        padding: 5px;
        text-align: middle;
        width: 100px;
    }

    div {
        font-size: 30px;
    }

    canvas#my-canvas {
        background-color: rgb(100,100,100);
    }

    caption {
        font-size: 30px;
    }


    #rectangle {
        width:100px;
        height:50px;
        background:yellow;
    }

    #circle {
        width: 50px;
        height: 50px;
        background: red;
        border-radius: 50%;
        margin-left: auto;
        margin-right: auto;
    }

    #start {
        width: 50px;
        height: 50px;
        background: black;
        border-radius: 50%;
        margin-left: auto;
        margin-right: auto;
    }

    #end {
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 50%;
        margin-left: auto;
        margin-right: auto;
    }

</style>
<script>
    var canvas = null;
    var canvasPosition = null;
    var context = null;
    var drag = false;
    var dragStart;
    var dragEnd;
    let mouseUpEvent = false;

    var nodes = [];
    var edges = [];

    var selectedIndex = null;

    function getNode(id){
        //nodes.find(node => node.id === id);
        let node = nodes.filter((node) =>  node.id === parseInt(id));        
        return node[0];
    }

    function draw()
    {
        for (var i = 0; i < nodes.length; ++i) {
            var node = nodes[i];
            if (node["type"] == "rectangle")
            {
                context.beginPath();
                context.lineWidth = 6;
                context.fillStyle = "yellow";
                context.fillRect(node["x"], node["y"], node["width"], node["height"]); //ekkorát rajzol ki: 100 x 50
                context.stroke();
                context.fillStyle = "blue";
                context.fillText(node["text"],node["x"]+node["width"]/2, node["y"]+node["height"]/2);
            }

            if(node["type"] == "circle")
            {
                context.beginPath();
                context.arc(node["x"], node["y"], node["radius"], 0, 2 * Math.PI);
                context.fillStyle = "red";
                context.fill();
                context.fillStyle = "blue";
                context.fillText(node["text"],node["x"], node["y"]);
            }

            // TODO: ebből csak 1 db-ot lehessen hozzáadni:
            if(node["type"] == "start")
            {
                context.beginPath();
                context.lineWidth = 3;
                context.setLineDash([]);
                context.arc(60, 60, 40, 0, 2 * Math.PI);
                context.stroke();
                context.fillStyle = "black";
                context.font = "20px Arial";
                context.textBaseline = 'middle';
                context.textAlign = "center";
                context.fillText("Start",60, 60);
            }
        }

        for (var i = 0; i < edges.length; ++i) {
            // TODO: a vonalak elég random mozognak, valami szabálykövetőbb mozgás kéne
            // TODO: a vonalak ne látszódjanak a node-okon
            var edge = edges[i];
            var sourceNodeIndex = edges[i]["from"];
            var targetNodeIndex = edges[i]["to"];
            console.log(sourceNodeIndex);
            console.log(targetNodeIndex);
            var sourceNode = getNode(sourceNodeIndex);//nodes[sourceNodeIndex];
            var targetNode = getNode(targetNodeIndex);//nodes[targetNodeIndex];
            // context.moveTo(edges[i]["moveto"]["x"]+50, edges[i]["moveto"]["y"]+50);
            // context.lineTo(edges[i]["lineto"]["x"]+50, edges[i]["lineto"]["y"]);
            context.beginPath();
            context.lineWidth = 3;
            context.strokeStyle = "black";
            //try {
                var dx = targetNode["x"] - sourceNode["x"];
                var dy = targetNode["y"] - sourceNode["y"];
                // INFO: x+50: node bal felső sarkától 50-nel jobbra. Ez van kicserélve sN["width"]/2 -re, ezért nem működik körnél
                context.moveTo(sourceNode["x"] + sourceNode["width"]/2, sourceNode["y"] + sourceNode["height"]/2);
                if(edge["type"] == "dashed")
                {
                    context.setLineDash([6, 7]);
                }
                if(edge["type"] == "continuous")
                {
                    context.setLineDash([]);
                }            
                context.bezierCurveTo(sourceNode["x"] + dx * 0.33 + 50, sourceNode["y"] + sourceNode["width"]/2, sourceNode["x"] + dx * 0.67 +50, targetNode["y"], targetNode["x"] + targetNode["width"]/2, targetNode["y"] + targetNode["height"]/2);
                context.stroke();
                /* //ez a nyíl lesz majd valahogy
                context.beginPath();
                context.setLineDash([]);
                context.fillStyle = "black";
                context.moveTo(targetNode["x"] + 50, targetNode["y"]);
                context.lineTo(targetNode["x"] + 65, targetNode["y"] -15);
                context.moveTo(targetNode["x"] + 50, targetNode["y"]);
                context.lineTo(targetNode["x"] + 35, targetNode["y"] -15);
                context.stroke();
                */
            /*} catch (err) {
                alert("Rossz ID. Innen már nincs visszaút");
            }*/
        }
    }

    function clear()
    {
        context.save();
        context.setTransform(1, 0, 0, 1, 0, 0);
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.restore();
    }

    function calcMouseEvent(event)
    {
        draw();
        return {
            "x": event.clientX - canvasPosition.left,
            "y": event.clientY - canvasPosition.top,
            "button": event.button
        };
    }

    function mouseDown(event)
    {
        //mouseDown = false;
        //mouseUp = false;
        clear();
        const mouse = calcMouseEvent(event);
        selectedIndex = null;
        for (var i = 0; i < nodes.length; ++i) {
            var node = nodes[i];
            if(node["type"] == "rectangle")
            {
                if (mouse["x"] >= node["x"]
                    && mouse["x"] <= node["x"] + node["width"] //+width hogy az egész node-ot húzni tudd
                    && mouse["y"] >= node["y"]
                    && mouse["y"] <= node["y"] + node["height"])
                {
                    selectedIndex = i;
                }
            }

            // TODO: kör mozgatási terület kijelölés - megírni rendesen ezt is
            if (node["type"] == "circle")
            {
                if (mouse["x"] >= node["x"]
                    && mouse["x"] <= node["x"] + node["radius"]
                    && mouse["y"] >= node["y"]
                    && mouse["y"] <= node["y"] + node["radius"])
                {
                    selectedIndex = i;
                }
            }
        }
        dragStart = {
            x: event.clientX - canvasPosition.left,
            y: event.clientY - canvasPosition.top
        };
        drag = true;
    }

    function mouseMove(event)
    { 
        mouseUpEvent = false;
        const mouse = calcMouseEvent(event);
        if (drag) {
            dragEnd = {
                x: event.clientX - canvasPosition.left,
                y: event.clientY - canvasPosition.top
            }
            if (selectedIndex != null) {
                var dx = dragEnd.x - dragStart.x;
                var dy = dragEnd.y - dragStart.y;
                nodes[selectedIndex]["x"] += dx;
                nodes[selectedIndex]["y"] += dy;
            }
            clear();
            draw();
            dragStart = dragEnd;
        }
    }

    function mouseUp(event)
    {
        const mouse = calcMouseEvent(event);
        drag = false;
        mouseDown = false;

        selectedIndex = null;
        for (var i = 0; i < nodes.length; ++i) {
            var node = nodes[i];

            //téglalapra kattintás - nincs baj, mert m x n méretű, nem úgy, mint a kör
            if(node["type"] == "rectangle")
            {
                if (mouse["x"] >= node["x"]
                    && mouse["x"] <= node["x"] + node["width"] //+width hogy az egész node-ot húzni tudd
                    && mouse["y"] >= node["y"]
                    && mouse["y"] <= node["y"] + node["height"])
                {
                    selectedIndex = i;
                    console.log(event);
                    if (mouseUpEvent === true){
                        document.getElementById("addText").style.display = "";
                        context.fillStyle = "orange";
                        context.font = "20px Arial";
                        context.textBaseline = 'middle';
                        context.textAlign = "center";
                        context.fillText("A node id-ja: "+node["id"], canvas.width-100, canvas.height-30);
                    }
                }
            }

            // TODO: kör kattintás érzékelés tényleg csak a körre kattintást érzékelje
            if(node["type"] == "circle")
            {
                if (mouse["x"] >= node["x"]
                    && mouse["x"] <= node["x"] + node["radius"] 
                    && mouse["y"] >= node["y"]
                    && mouse["y"] <= node["y"] + node["radius"])
                {
                    selectedIndex = i;
                    console.log(event);
                    if (mouseUpEvent === true){
                        document.getElementById("addText").style.display = "";
                        context.fillStyle = "orange";
                        context.font = "20px Arial";
                        context.textBaseline = 'middle';
                        context.textAlign = "center";
                        context.fillText("A node id-ja: "+node["id"], canvas.width-100, canvas.height-30);
                    }
                }
            }
        }
        mouseUpEvent = true;
    }

    function mouseWheel(event)
    {
        const mouse = calcMouseEvent(event);
        const delta = event.wheelDelta;
        event.preventDefault();
    }

    function keyUp(event)
    {

    }

    function keyDown(event)
    {
        //Csak hogy valami legyen a keyDown-ban is
        var letter = event.key;
        if (event.keyCode === 27) { //ESC
            closeEdge();
            closeText();
            //popup-ok bezárása
        }
    }


    function initialize()
    {
        canvas = document.getElementById("my-canvas");
        canvasPosition = canvas.getBoundingClientRect();
        window.addEventListener("keydown", keyDown, false);
        window.addEventListener("keyup", keyUp, false);
        canvas.addEventListener("mousedown", mouseDown, false);
        canvas.addEventListener("mousemove", mouseMove, false);
        canvas.addEventListener("mouseup", mouseUp, false);
        canvas.addEventListener("mousewheel", mouseWheel, false);
        context = canvas.getContext("2d");
    }

    function openEdge() {
        document.getElementById("addEdge").style.display = "block";
    }

    function closeEdge() {
        document.getElementById("addEdge").style.display = "none";
    }

    function closeText() {
        document.getElementById("addText").style.display = "none";
    }

    function addTextToRectangle(value) {
        nodes[selectedIndex]["text"] = value;
        context.font = "20px Arial";
        context.textBaseline = 'middle';
        context.textAlign = "center";
        context.fillText(value, nodes[selectedIndex]["x"]+nodes[selectedIndex]["width"]/2, nodes[selectedIndex]["y"]+nodes[selectedIndex]["height"]/2);
        if(14 > nodes[selectedIndex]["width"] / value.length)
        {
            nodes[selectedIndex]["width"] += 14;
        }
        /* // TODO: height növelése + sor törés egy bizonyos hossz után
        if(nodes[selectedIndex]["width"] > 150)
        {
            nodes[selectedIndex]["height"] = 80;
        }*/
    }

    function addId() {
        let max = 0;
        if(nodes.length !==0){
            nodes.forEach(e => {
                if(e.id >max) {
                    max = e.id;
                }
            });
        }
        return max;
    }    

    function addRectangle() {
        var newid = addId();
        nodes.push( {"id": newid+1, "type": "rectangle", "x": 100, "y": 100, "text": "", "width": 100, "height": 50})
        // INFO: az itt megadott height, width értékeket nézi a text hozzáadós a node["width"]
    }

    //addCircles
    function addCircle() {
        var newid = addId();
        nodes.push( {"id": newid+1, "type": "circle", "x": 200, "y": 100, "text": "", "radius": 40, "width": 0, "height": 0})
    }

    //addStart
    function addStart() {
        nodes.push( {"id": 0, "type": "start", "x": 60, "y": 60, "width": 0, "height": 0})
        // TODO: csak 1 legyen belőle
    }

    function addEdge(from, to) {
        // TODO: Nem létező értéket ne lehessen hozzáadni
        let edge1 = document.getElementById("edge1").value;
        let edge2 = document.getElementById("edge2").value;
        edges.push({"from": edge1, "to": edge2, "type": "dashed"});
        edge1 = document.getElementById("edge1").value = '';
        edge2 = document.getElementById("edge2").value = '';
    }

    function folytonos(from, to) {
        // TODO: Hasonlít a sima addEdge-hez, valahogy mixelni kéne a kettőt
        let edge1 = document.getElementById("edge1").value;
        let edge2 = document.getElementById("edge2").value;
        edges.push({"from": edge1, "to": edge2, "type": "continuous"});
        edge1 = document.getElementById("edge1").value = '';
        edge2 = document.getElementById("edge2").value = '';
    }

    function resize() {
        nodes[selectedIndex]["width"] = parseInt(document.getElementById("width").value);
        nodes[selectedIndex]["height"] = parseInt(document.getElementById("height").value);
    }

    function removeNode() {
        // TODO
        // INFO: node törlése esetén törlődnek a hozzákapcsolt vonalak is
    }


</script>

<body onload="initialize()">
<canvas id="my-canvas" width="800" height="600"></canvas>

<table border=10>
    <caption>Toolbox</caption>
    <tr>
      <th>
        <p>Add node</p>
      </th>
      <th>
        <p>Add circle</p>
      </th>
      <th>
        <p>Add start</p>
      </th>
      <th>
        <p>Add edge</p>
      </th>
    </tr>
    <tr>
      <td>
            <!-- node hozzáadás-->
            <div id="rectangle" onclick="addRectangle()"></div>
      </td>
      <td>
            <!-- kör hozzáadás-->
            <div id="circle" onclick="addCircle()"></div>
      </td>
      <td>
            <!-- start hozzáadás-->
            <div id="start" onclick="addStart()"></div>
      </td>
      <td>
        <div class="addEdge">
            <!-- add vonal -->
            <button onclick="openEdge()">Add edge</button>
        </div>
      </td>
    </tr>
  </table>

<!-- add edge-->
<div id="addEdge" style="display: none">
    <span class="helper"></span>
    <div>
        <label for="textInput" >From</label>
        <input type="number" name="edge1" id="edge1">
    </div>
    <div>
        <label for="textInput" >To</label>
        <input type="number" name="edge2" id="edge2">
    </div>
    <div>
        <button onclick="addEdge()">Dashed</button>
        <button onclick="folytonos()">Continuous</button>
        <button onclick="closeEdge()">Close</button>
    </div>
</div>

<!-- szöveg bevitel, újraméretezés -->
<div id="addText" style="display: none">
    <span class="helper"></span>
    <div>
        <label for="textInput" >Type text here: </label>
        <input type="text" onfocus="this.value=''" name="textInput" id="textInput" onkeyup="addTextToRectangle(this.value)">
    </div>
    <div>
        <label for="textInput" >Type width here: </label>
        <input type="number" name="width" id="width">
    </div>
    <div>
        <label for="textInput" >Type height here: </label>
        <input type="number" name="height" id="height">
    </div>
    <div>
        <button onclick="resize()">Resize</button>
        <button onclick="closeText()">Close</button>
    </div>
</div>
</body>
</html>